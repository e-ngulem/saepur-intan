<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Broadcast Undangan</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-cell {
            padding: 12px 16px;
            border-bottom-width: 1px;
        }
        .status-sent { color: #22c55e; } /* green-500 */
        .status-error { color: #ef4444; } /* red-500 */
        .status-sending { color: #3b82f6; } /* blue-500 */
        .status-ready { color: #eab308; } /* yellow-500 */
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-8">
            
            <!-- Header -->
            <div class="text-center">
                <h1 class="text-3xl font-bold tracking-tight text-white">WA Broadcast Undangan Pernikahan</h1>
                <p class="mt-2 text-gray-400">Kirim undangan massal via WhatsApp dengan Fonnte.</p>
            </div>

            <!-- Step 1: Configuration -->
            <div>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-cyan-400 pl-4">Langkah 1: Konfigurasi API & Pesan</h2>
                <div class="space-y-6">
                    <!-- API Key Input -->
                    <div class="space-y-2">
                        <label for="apiKey" class="block text-sm font-medium text-gray-300">Fonnte API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" value="nMKJhEvhrR1uuJ3uksJe">
                        <p class="text-xs text-yellow-500">PENTING: Jangan bagikan API Key Anda kepada siapapun.</p>
                    </div>
                    
                    <!-- Toggle button and collapsible content -->
                    <div>
                        <button id="toggleTemplateButton" class="w-full flex justify-between items-center p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium text-gray-300 transition-colors">
                            <span>Tampilkan/Ubah Template Pesan</span>
                            <svg id="templateChevron" class="w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        
                        <!-- Message Template -->
                        <div id="messageTemplateContainer" class="space-y-2 mt-4 hidden">
                            <label for="messageTemplate" class="block text-sm font-medium text-gray-300">Template Pesan</label>
                            <textarea id="messageTemplate" rows="12" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">Kepada Yth.
Bapak/Ibu/Saudara/i

Tanpa mengurangi rasa hormat, perkenankan kami mengundang Bapak/Ibu/Saudara/i, untuk menghadiri acara Resepsi Pernikahan Kami

Info lebih lengkap klik link dibawah ini
[LINK]

Merupakan suatu kebahagiaan bagi kami apabila Bapak/Ibu/Saudara/i berkenan untuk hadir dan memberikan doa restu.

Kami yang berbahagia
Keluarga Kedua Mempelai</textarea>
                            <p class="text-xs text-gray-400">Gunakan placeholder <span class="font-mono bg-gray-600 px-1 rounded">[NAMA]</span> dan <span class="font-mono bg-gray-600 px-1 rounded">[LINK]</span>. Keduanya akan diganti otomatis.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload Excel -->
            <div>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-cyan-400 pl-4">Langkah 2: Upload File Excel</h2>
                 <div class="space-y-2">
                    <label for="excelFile" class="block text-sm font-medium text-gray-300">Pilih File (.xlsx, .xls, .csv)</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer">
                    <p class="text-xs text-gray-400">Pastikan file Excel Anda memiliki kolom dengan header <span class="font-mono bg-gray-600 px-1 rounded">nama</span> dan <span class="font-mono bg-gray-600 px-1 rounded">nowa</span>.</p>
                </div>
            </div>
            
            <!-- Step 3: Preview & Send -->
            <div>
                 <h2 class="text-xl font-semibold mb-4 border-l-4 border-cyan-400 pl-4">Langkah 3: Preview Data & Kirim</h2>
                <div class="bg-gray-700/50 rounded-lg overflow-hidden border border-gray-700">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="table-cell font-semibold">No.</th>
                                    <th class="table-cell font-semibold">Nama</th>
                                    <th class="table-cell font-semibold">No. WhatsApp</th>
                                    <th class="table-cell font-semibold">Status</th>
                                    <th class="table-cell font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="contactTableBody">
                                <tr>
                                    <td colspan="5" class="table-cell text-center text-gray-400">Belum ada data. Silakan upload file Excel.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                     <p id="dataSummary" class="text-sm text-gray-400">Total: 0 data</p>
                     <button id="sendButton" disabled class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed">
                         Kirim Broadcast
                     </button>
                </div>
            </div>

            <!-- Log Area -->
            <div>
                 <h2 class="text-xl font-semibold mb-4 border-l-4 border-cyan-400 pl-4">Log Pengiriman</h2>
                 <div id="logArea" class="bg-black h-40 rounded-lg p-4 font-mono text-xs text-gray-300 overflow-y-auto border border-gray-700">
                    [INFO] Menunggu proses pengiriman...
                 </div>
            </div>
        </div>
    </div>

    <script>
        // Global variable to store contact data from Excel
        let contacts = [];
        const excelFileInput = document.getElementById('excelFile');
        const contactTableBody = document.getElementById('contactTableBody');
        const sendButton = document.getElementById('sendButton');
        const apiKeyInput = document.getElementById('apiKey');
        const messageTemplateInput = document.getElementById('messageTemplate');
        const logArea = document.getElementById('logArea');
        const dataSummary = document.getElementById('dataSummary');
        const toggleTemplateButton = document.getElementById('toggleTemplateButton');
        const messageTemplateContainer = document.getElementById('messageTemplateContainer');
        const templateChevron = document.getElementById('templateChevron');

        /**
         * Adds a message to the log area with a timestamp.
         * @param {string} message - The message to log.
         * @param {string} type - 'INFO', 'SUCCESS', or 'ERROR'.
         */
        function logMessage(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            let typeColor = 'text-gray-400';
            if (type === 'SUCCESS') typeColor = 'text-green-400';
            if (type === 'ERROR') typeColor = 'text-red-400';
            
            logEntry.innerHTML = `<span class="text-cyan-400">[${timestamp}]</span> <span class="${typeColor}">[${type}]</span> ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; // Auto-scroll to bottom
        }

        /**
         * Handles the file input change event to read the Excel file.
         */
        excelFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                logMessage('Tidak ada file yang dipilih.', 'ERROR');
                return;
            }
            
            logMessage(`Membaca file: ${file.name}`);
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        // Ensure headers are lowercase and have no spaces
                        header: 1, 
                        transform: (h) => h.toLowerCase().replace(/ /g, '')
                    });
                    
                    // Remap to a consistent object structure
                    const headers = jsonData[0];
                    const nameIndex = headers.indexOf('nama');
                    const nowaIndex = headers.indexOf('nowa');

                    if (nameIndex === -1 || nowaIndex === -1) {
                         throw new Error("Kolom 'nama' atau 'nowa' tidak ditemukan di file Excel.");
                    }

                    contacts = jsonData.slice(1).map((row, index) => ({
                        id: index,
                        nama: row[nameIndex] ? String(row[nameIndex]) : '',
                        nowa: row[nowaIndex] ? String(row[nowaIndex]) : '',
                    })).filter(c => c.nama); // Filter out rows without a name

                    if (contacts.length === 0) {
                        throw new Error("Tidak ada data valid yang ditemukan di file Excel.");
                    }

                    logMessage(`Berhasil membaca ${contacts.length} kontak.`, 'SUCCESS');
                    displayContacts();
                } catch (error) {
                    logMessage(`Gagal memproses file Excel: ${error.message}`, 'ERROR');
                    contacts = [];
                    displayContacts(); // Clear table
                }
            };
            
            reader.onerror = (error) => {
                logMessage('Gagal membaca file.', 'ERROR');
                console.error('File reading error:', error);
            };

            reader.readAsArrayBuffer(file);
        });
        
        /**
         * Toggles the visibility of the message template.
         */
        toggleTemplateButton.addEventListener('click', () => {
            messageTemplateContainer.classList.toggle('hidden');
            templateChevron.classList.toggle('rotate-180');
        });

        /**
         * Displays the contacts in the HTML table.
         */
        function displayContacts() {
            contactTableBody.innerHTML = ''; // Clear previous data
            
            if (contacts.length === 0) {
                contactTableBody.innerHTML = '<tr><td colspan="5" class="table-cell text-center text-gray-400">Belum ada data. Silakan upload file Excel.</td></tr>';
                sendButton.disabled = true;
                dataSummary.textContent = 'Total: 0 data';
                return;
            }
            
            // Sort contacts to show those with WhatsApp numbers first
            const sortedContacts = [...contacts].sort((a, b) => {
                const aHasWa = a.nowa && a.nowa.trim() !== '';
                const bHasWa = b.nowa && b.nowa.trim() !== '';
                return (bHasWa - aHasWa); // Puts items with WA number first
            });
            
            sortedContacts.forEach((contact, index) => {
                const row = document.createElement('tr');
                row.id = `contact-row-${contact.id}`;
                row.className = 'border-b border-gray-700 hover:bg-gray-700/70';

                const hasWhatsAppNumber = contact.nowa && contact.nowa.trim() !== '';

                let statusHtml, actionHtml, nowaHtml;

                if (hasWhatsAppNumber) {
                    nowaHtml = `<td class="table-cell text-gray-300 font-mono">${contact.nowa}</td>`;
                    statusHtml = `<td class="table-cell status-ready" id="status-${contact.id}">Ready</td>`;
                    actionHtml = `
                        <td class="table-cell">
                            <button onclick="copyMessage(${contact.id})" class="copy-button bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded transition-colors duration-200">
                                Copy
                            </button>
                        </td>`;
                } else {
                    nowaHtml = `<td class="table-cell text-gray-500 italic">Tidak ada nomor</td>`;
                    statusHtml = `<td class="table-cell text-gray-500" id="status-${contact.id}">-</td>`;
                    actionHtml = `
                        <td class="table-cell">
                            <button onclick="copyMessage(${contact.id})" class="copy-button bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded transition-colors duration-200">
                                Copy
                            </button>
                        </td>`;
                }

                row.innerHTML = `
                    <td class="table-cell text-gray-400">${index + 1}</td>
                    <td class="table-cell">${contact.nama}</td>
                    ${nowaHtml}
                    ${statusHtml}
                    ${actionHtml}
                `;
                contactTableBody.appendChild(row);
            });
            
            const validContactsCount = contacts.filter(c => c.nowa && c.nowa.trim() !== '').length;
            sendButton.disabled = validContactsCount === 0;
            dataSummary.textContent = `Total: ${contacts.length} data (${validContactsCount} akan dikirim)`;
        }
        
        /**
         * Copies the generated message for a specific contact to the clipboard.
         * @param {number} contactId - The ID of the contact.
         */
        function copyMessage(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) {
                logMessage(`Kontak dengan ID ${contactId} tidak ditemukan.`, 'ERROR');
                return;
            }

            const originalMessage = messageTemplateInput.value;
            // The template originally did not include [NAMA], but it's good practice to add it for clarity
            // let finalMessage = originalMessage.replace(/Bapak\/Ibu\/Saudara\/i/g, `Bapak/Ibu/Saudara/i ${contact.nama}`);
            let finalMessage = originalMessage.replace(/Bapak\/Ibu\/Saudara\/i/g, `Bapak/Ibu/Saudara/i`);

            const formattedName = contact.nama.replace(/ /g, '%20');
            const dynamicLink = `https://e-ngulem.github.io/saepur-intan/?to=${formattedName}`;
            
            finalMessage = finalMessage.replace(/\[LINK\]/g, dynamicLink);
            
            // Fallback method using document.execCommand for better compatibility
            const textArea = document.createElement("textarea");
            textArea.value = finalMessage;
            // Make it invisible
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    logMessage(`Pesan untuk ${contact.nama} berhasil disalin.`, 'SUCCESS');
                    const button = document.querySelector(`#contact-row-${contactId} .copy-button`);
                    if (button) {
                        const originalText = button.textContent;
                        button.textContent = 'Tersalin!';
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-green-600');
                        button.disabled = true;
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.classList.remove('bg-green-600');
                            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            button.disabled = false;
                        }, 2000); // Revert back after 2 seconds
                    }
                } else {
                    throw new Error('Gagal mengeksekusi perintah copy.');
                }
            } catch (err) {
                logMessage(`Gagal menyalin pesan. Coba lagi secara manual.`, 'ERROR');
            }

            document.body.removeChild(textArea);
        }


        /**
         * Sends a single WhatsApp message using the Fonnte API.
         * @param {object} contact - The contact object { id, nama, nowa }.
         */
        async function sendWhatsappMessage(contact) {
            const statusCell = document.getElementById(`status-${contact.id}`);
            statusCell.textContent = 'Mengirim...';
            statusCell.className = 'table-cell status-sending';
            
            try {
                const apiKey = apiKeyInput.value;
                if (!apiKey) {
                    throw new Error("API Key Fonnte tidak boleh kosong.");
                }

                const originalMessage = messageTemplateInput.value;

                // Automatically add the name to the greeting
                let finalMessage = originalMessage.replace(/Bapak\/Ibu\/Saudara\/i/g, `Bapak/Ibu/Saudara/i ${contact.nama}`);

                const formattedName = contact.nama.replace(/ /g, '%20');
                const dynamicLink = `https://e-ngulem.github.io/saepur-intan/?to=${formattedName}`;
                
                finalMessage = finalMessage.replace(/\[LINK\]/g, dynamicLink);

                // Fonnte API endpoint
                const url = 'https://api.fonnte.com/send';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'target': contact.nowa,
                        'message': finalMessage,
                        'countryCode': '62' // Indonesia
                    })
                });

                const result = await response.json();

                if (response.ok && result.status === true) {
                    statusCell.textContent = 'Terkirim';
                    statusCell.className = 'table-cell status-sent';
                    logMessage(`Pesan ke ${contact.nama} (${contact.nowa}) berhasil terkirim.`, 'SUCCESS');
                } else {
                    const errorMessage = result.reason || JSON.stringify(result.detail) || 'Unknown error';
                    throw new Error(errorMessage);
                }

            } catch (error) {
                statusCell.textContent = `Gagal: ${error.message}`;
                statusCell.className = 'table-cell status-error';
                logMessage(`Pesan ke ${contact.nama} (${contact.nowa}) gagal: ${error.message}`, 'ERROR');
            }
        }
        
        /**
         * Handles the click event for the send button to start the broadcast.
         */
        sendButton.addEventListener('click', async () => {
            const contactsToSend = contacts.filter(c => c.nowa && c.nowa.trim() !== '');

            if (contactsToSend.length === 0) {
                logMessage('Tidak ada kontak valid dengan nomor WhatsApp untuk dikirim.', 'ERROR');
                return;
            }

            sendButton.disabled = true;
            sendButton.textContent = 'Mengirim...';
            logMessage(`Memulai proses broadcast untuk ${contactsToSend.length} kontak...`);

            for (const contact of contactsToSend) {
                await sendWhatsappMessage(contact);
                // Add a small delay between messages to avoid being flagged as spam
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
            }
            
            logMessage('Proses broadcast selesai.', 'INFO');
            sendButton.disabled = false;
            sendButton.textContent = 'Kirim Broadcast';
        });

    </script>
</body>
</html>




